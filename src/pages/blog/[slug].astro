---
import { type CollectionEntry, getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import BlogPost from '../../layouts/BlogPost.astro';
import { render } from 'astro:content';
import { slugifyPost } from '../../helpers';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: slugifyPost(post) },
		props: post,
	}));
}

interface BlogTitle {
	title: string;
	description: string;
}

type Props = CollectionEntry<'blog'> & BlogTitle;

const { title, description, ...post } = Astro.props;
const { Content } = await render(post);
---
<Base title={title} description={description}>
	<BlogPost {...post.data}>
		<Content />
	</BlogPost>
</Base>

<style is:global>
	@layer specifics {
		:root {
			--code-diff-add-symbol: #18794e;
			--code-diff-add-highlight: rgba(16 185 129 / 0.15);
			--code-diff-remove-symbol: #b34e52;
			--code-diff-remove-highlight: rgba(244 63 94 / 0.15);
			--code-line-annotate: rgba(27 166 115 / 1);
			--code-line-annotate-bg: rgba(27 166 115 / 0.13);
			--code-line-log: rgba(55 114 207 / 1);
			--code-line-log-bg: rgba(55 114 207 / 0.13);
			--code-line-warning: rgba(195 125 13 / 1);
			--code-line-warning-bg: rgba(195 125 13 / 0.13);
			--code-line-error: rgba(212 86 86 / 1);
			--code-line-error-bg: rgba(212 86 86 / 0.13);
		}

		.prose {
			font-size: 1.25rem;
		
			& a {
				@media (prefers-color-scheme: light) {
					color: var(--blog-accent-light);
				}

				@media (prefers-color-scheme: dark) {
					color: var(--blog-accent-dark);
				}
			}
		}

		figure[data-code-block-figure] {
			position: relative;
			font-size: 1rem; 
			margin: 0 1.5rem 0 1.5rem;
			overflow-y: hidden;
			border: solid rgba(115 138 148 / 50%) 1px;
			border-radius: 8px;

			& [data-code-caption] {
				display: flex;
				justify-content: space-between;

				@media (prefers-color-scheme: light) {
					color: var(--shiki-caption-light);
					background-color: var(--shiki-caption-light-bg);
				}

				@media (prefers-color-scheme: dark) {
					color: var(--shiki-caption-dark);
					background-color: var(--shiki-caption-dark-bg);
				}

				& span[data-code-title] {
					position: absolute;
					left: 0;
					top: 0;
					font-size: 1.1rem;
					padding-left: 0.75rem;
					padding-right: 0.75rem;
					border-bottom: solid 1px transparent;
					text-align: right;

					@media (prefers-color-scheme: light) {
						color: var(--shiki-light);
						background-color: var(--shiki-light-bg);
						border-top: solid 3px var(--blog-accent-light);
					}

					@media (prefers-color-scheme: dark) {
						color: var(--shiki-dark);
						background-color: var(--shiki-dark-bg);
						border-top: solid 3px var(--blog-accent-dark);
					}

					& [data-code-title-fade] {
						opacity: 0.4;
					}
				}

				& span[data-code-title-language] {
					text-transform: uppercase;
					font-weight: bold;
					letter-spacing: 1px;
					margin-left: auto;
					padding-left: 0.75rem;
					padding-right: 0.75rem;
				}
			}
		}

		.astro-code,
		.astro-code code {

			@media (prefers-color-scheme: light) {
				background-color: var(--shiki-light-bg);
			}

			@media (prefers-color-scheme: dark) {
				background-color: var(--shiki-dark-bg);
			}

			& span {
				@media (prefers-color-scheme: light) {
					color: var(--shiki-light);
					font-style: var(--shiki-light-font-style);
					font-weight: var(--shiki-light-font-weight);
					text-decoration: var(--shiki-light-text-decoration);
				}

				@media (prefers-color-scheme: dark) {
					color: var(--shiki-dark);
					font-style: var(--shiki-dark-font-style);
					font-weight: var(--shiki-dark-font-weight);
					text-decoration: var(--shiki-dark-text-decoration);
				}
			}
		}

		p > code {
			font-size: 0.9em;
			border-radius: 5px;
			border: solid rgba(115 138 148 / 50%) 1px;
			padding: 2px;
		}

		.astro-code {
			padding-top: 0.25rem;
			margin: 0;
			z-index: 5;

			&[data-inline-code] {
				font-size: 0.9em;
				border-radius: 5px;
				border: solid rgba(115 138 148 / 50%) 1px;
				padding: 2px;
			}

			&[data-block-code] {
				border-radius: 0;

				& code {
					display: grid;

					& .diff.add {
						background-color: var(--code-diff-add-highlight);
						opacity: 0.9;

						& [data-line-code-pre-ws]::before {
							content: '++';
							position: absolute;
							text-align: center;
							width: 2rem;
							color: var(--code-diff-add-symbol);
						}
					}

					& .diff.remove {
						background-color: var(--code-diff-remove-highlight);
						opacity: 0.9;

						& [data-line-code-pre-ws]::before {
							content: '--';
							position: absolute;
							text-align: center;
							width: 2rem;
							color: var(--code-diff-remove-symbol);
						}
					}

					& .highlighted.error {
						background-color: var(--code-line-error);
						opacity: 0.9;
					}

					& .highlighted.warning {
						background-color: var(--code-line-warning);
						opacity: 0.9;
					}
				}

				& code[data-line-number-max-digits="1"] {
					& span.diff.add [data-line-code-pre-ws]::before,
					& span.diff.remove [data-line-code-pre-ws]::before {
						left: 1.25rem;
					}
				}

				& code[data-line-number-max-digits="2"] {
					& span.diff.add [data-line-code-pre-ws]::before,
					& span.diff.remove [data-line-code-pre-ws]::before {
						left: 2rem;
					}
				}

				& code[data-line-number-max-digits="3"] {
					& span.diff.add [data-line-code-pre-ws]::before,
					& span.diff.remove [data-line-code-pre-ws]::before {
						left: 2.75rem;
					}
				}

				& code[data-line-number-max-digits="4"] {
					& span.diff.add [data-line-code-pre-ws]::before,
					& span.diff.remove [data-line-code-pre-ws]::before {
						left: 3.5rem;
					}
				}

				& span.line {
					display: flex;
					position: relative;
					white-space : pre-wrap !important;
					overflow-x: hidden;

					&[data-highlighted-line] {
						@media (prefers-color-scheme: light) {
							background-color: var(--shiki-highlighted-light-bg);
						}

						@media (prefers-color-scheme: dark) {
							background-color: var(--shiki-highlighted-dark-bg);
						}
					}

					&[data-line-message] {
						& > span {
							position: relative;
							padding: 6px 10px;
							margin: 0.2em 0;
							display: flex;
							justify-content: flex-start;
							align-items: center;
							gap: 0.5em;
							min-width: 100%;
							box-sizing: border-box;
							border-left-width: 3px;
							border-left-style: solid;

							&[data-line-message-type="annotation"] {
								border-left-color: var(--code-line-annotate);
								color: var(--code-line-annotate);
								background-color: var(--code-line-annotate-bg);
							}

							&[data-line-message-type="log"] {
								border-left-color: var(--code-line-log);
								color: var(--code-line-log);
								background-color: var(--code-line-log-bg);
							}

							&[data-line-message-type="warning"] {
								border-left-color: var(--code-line-warning);
								color: var(--code-line-warning);
								background-color: var(--code-line-warning-bg);
							}

							&[data-line-message-type="error"] {
								border-left-color: var(--code-line-error);
								color: var(--code-line-error);
								background-color: var(--code-line-error-bg);
							}

							& [data-line-message-icon] {
								width: 1.1em;
								color: inherit;

								& svg {
									display: block;
									color: inherit;
									width: 1rem;
								}
							}
						}

						
					}

					& mark[data-highlighted-chars] {
						border-radius: 3px;

						@media (prefers-color-scheme: light) {
							border: 1px solid var(--shiki-light);
							background-color: var(--shiki-highlighted-light-bg);
						}

						@media (prefers-color-scheme: dark) {
							border: 1px solid var(--shiki-dark);
							background-color: var(--shiki-highlighted-dark-bg);
						}
					}

					& span[data-line-number] {
						width: 0.75rem;
						height: 100%;
						display: inline-block;
						text-align: right;
						vertical-align: top;
						padding-right: 7px;
						float: left;
						flex-grow: 0;
						flex-shrink: 0;

						@media (prefers-color-scheme: light) {
							border-right: 1px solid var(--shiki-lineno-light);
							color: var(--shiki-lineno-light);
						}

						@media (prefers-color-scheme: dark) {
							border-right: 1px solid var(--shiki-lineno-dark);
							color: var(--shiki-lineno-dark);
						}

						[data-line-number-max-digits="2"] & {
							width: 1.5rem;
						}

						[data-line-number-max-digits="3"] & {
							width: 2.25rem;
						}

						[data-line-number-max-digits="4"] & {
							width: 3rem;
						}
					}

					& span[data-line-code-pre-ws] {
						padding-left: 2rem;
						flex-shrink: 0;
					}

					& span[data-line-code] {
						text-wrap: wrap;
						text-indent: 2.2em hanging;
					}
 
					& span[data-line-code-pre-ws],
					& span[data-line-code] {
						display: inline-block;
						vertical-align: top;
						height: 100%;

						& [data-line-tab], & [data-line-space] {
							position: relative;
						}

						& [data-line-tab]::before {
							content: '⇥';
							position: absolute;
							opacity: 0.3;
						}

						& [data-line-space]::before {
							content: '·';
							position: absolute;
							opacity: 0.3;
						}
					}
				}
			}
		}

		figure[data-code-block-figure] + p:has(cite) {
			margin-top: 0;
			margin-left: 1.5rem;
			margin-right: 1.5rem;
			font-size: 1.1rem;

			&::before {
				content: 'Source:';
				font-style: normal;
				padding-left: 0.5rem;
				padding-right: 0.5rem;
			}
		}

		.prose > p img {
			display: block;
		}

		img + cite {
			font-size: 1.1rem;

			&::before {
				content: 'Source:';
				font-style: normal;
				padding-left: 0.5rem;
				padding-right: 0.5rem;
			}
		}

		.prose > blockquote {
			position: relative;
			font-size: 1.1em;
			margin-left: 1.5em;

			@media (prefers-color-scheme: light) {
				border-left: 4px solid var(--blog-accent-light);
			}
			@media (prefers-color-scheme: dark) {
				border-left: 4px solid var(--blog-accent-dark);
			}

			& cite {
				display: block;
				margin-left: 3em;
				font-size: 1.1rem;

				&::before {
					content: '— ';
				}
			}
		}
	}
	

</style>